#include <Wire.h>
#include <U8g2lib.h>
#include "MAX30105.h"
#include <WiFi.h>
#include <Firebase_ESP_Client.h>
#include <time.h>

// ================= OLED =================
U8G2_SSD1306_128X64_NONAME_F_HW_I2C u8g2(U8G2_R0, U8X8_PIN_NONE);

// ================= MAX30102 =================
MAX30105 particleSensor;

// ================= BPM (NÃO MEXER) =================
const byte RATE_SIZE = 6;
byte rates[RATE_SIZE];
byte rateIndex = 0;
int bpmAvg = 0;

static long irAvg = 0;
static long irPrev = 0;
static bool rising = false;
static unsigned long lastBeatTime = 0;

// ================= SpO2 =================
long redAvg = 0;
long irAvgSpO2 = 0;
int spo2 = 0;

// ================= MAX30205 =================
#define MAX30205_ADDRESS 0x48
float temperatura = 0;

// ================= WIFI & FIREBASE =================
<<<<<<< HEAD
#define WIFI_SSID "PET Convidados"
=======
#define WIFI_SSID "PET Colaboardores"
>>>>>>> 02282985e6adffb91e45fa530261b7d70eb5a801
#define WIFI_PASSWORD "petagregado"
#define DATABASE_URL "projeto-integradora-ii-default-rtdb.firebaseio.com"
#define DATABASE_SECRET "uC0SyV22Gi3CEPqkslCwpJtPB1Kr2EAiH9JmrMVD"

FirebaseData fbdo;
FirebaseAuth auth;
FirebaseConfig config;

unsigned long lastFirebaseSend = 0;
const unsigned long FIREBASE_INTERVAL = 10000;

// =============================================================

void setup() {
  Serial.begin(115200);
  Wire.begin(21, 22);

  u8g2.begin();
  u8g2.setFont(u8g2_font_6x10_tr);

  if (!particleSensor.begin(Wire, I2C_SPEED_FAST)) {
    displayMessage("ERRO", "Sensor nao", "encontrado");
    while (1);
  }

  // CONFIGURAÇÃO IDEAL MAX30102
  particleSensor.setup(
    0x1F, 4, 2, 200, 215, 2048
  );

  particleSensor.setPulseAmplitudeIR(0x0F);
  particleSensor.setPulseAmplitudeRed(0x0F);

  initWiFi();
  initFirebase();

  configTime(-3 * 3600, 0, "pool.ntp.org");

  displayMessage("Aguardando", "coloque o", "dedo");
  delay(2000);
}

// =============================================================

void loop() {
  long irValue = particleSensor.getIR();
  long redValue = particleSensor.getRed();
  unsigned long now = millis();

  // ================= BPM (INALTERADO) =================
  irAvg = irAvg * 0.95 + irValue * 0.05;
  long signal = irValue - irAvg;

  if (signal > 1500 && irPrev < signal && !rising) {
    rising = true;
  }

  if (rising && signal < irPrev) {
    rising = false;

    if (lastBeatTime > 0) {
      unsigned long delta = now - lastBeatTime;
      float bpm = 60000.0 / delta;

      if (bpm > 40 && bpm < 180) {
        rates[rateIndex++] = (byte)bpm;
        rateIndex %= RATE_SIZE;

        bpmAvg = 0;
        for (byte i = 0; i < RATE_SIZE; i++)
          bpmAvg += rates[i];
        bpmAvg /= RATE_SIZE;

        Serial.print("BATIMENTO | BPM: ");
        Serial.println(bpmAvg);
      }
    }
    lastBeatTime = now;
  }

  irPrev = signal;

  // ================= SpO2 =================
  irAvgSpO2 = irAvgSpO2 * 0.95 + irValue * 0.05;
  redAvg    = redAvg    * 0.95 + redValue * 0.05;

  long irAC  = irValue  - irAvgSpO2;
  long redAC = redValue - redAvg;

  if (irAC > 500 && redAC > 500) {
    float ratio = (float(redAC) / redAvg) / (float(irAC) / irAvgSpO2);
    spo2 = 110 - 25 * ratio;
    spo2 = constrain(spo2, 85, 100);
  }

  // ================= Temperatura =================
  static unsigned long lastTemp = 0;
  if (millis() - lastTemp > 2000) {
    temperatura = readMAX30205();
    lastTemp = millis();
  }

  updateDisplay(irValue);

  if (millis() - lastFirebaseSend > FIREBASE_INTERVAL) {
    sendToFirebase();
    lastFirebaseSend = millis();
  }

  delay(10);
}

// =============================================================

float readMAX30205() {
  Wire.beginTransmission(MAX30205_ADDRESS);
  Wire.write(0x00);
  Wire.endTransmission(false);
  Wire.requestFrom(MAX30205_ADDRESS, 2);

  int16_t raw = (Wire.read() << 8) | Wire.read();
  return raw * 0.00390625;
}

// =============================================================

void updateDisplay(long ir) {
  u8g2.clearBuffer();
  u8g2.setFont(u8g2_font_6x10_tr);

  u8g2.setCursor(0, 12);
  u8g2.print("Temp: ");
  u8g2.print(temperatura, 1);
  u8g2.print(" C");

  u8g2.setCursor(0, 24);
  u8g2.print("BPM: ");
  bpmAvg > 0 ? u8g2.print(bpmAvg) : u8g2.print("--");

  u8g2.setCursor(0, 36);
  u8g2.print("SpO2: ");
  spo2 > 0 ? u8g2.print(spo2) : u8g2.print("--");
  u8g2.print(" %");

  u8g2.setCursor(0, 48);
  u8g2.print("IR: ");
  u8g2.print(ir);

  u8g2.sendBuffer();
}

// =============================================================

void initWiFi() {
  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
  while (WiFi.status() != WL_CONNECTED) delay(500);
}

void initFirebase() {
  config.database_url = DATABASE_URL;
  config.signer.tokens.legacy_token = DATABASE_SECRET;
  Firebase.begin(&config, &auth);
  Firebase.reconnectWiFi(true);
}

void sendToFirebase() {
  if (!Firebase.ready()) return;

  Firebase.RTDB.setFloat(&fbdo, "/atuais/temp", temperatura);
  Firebase.RTDB.setInt(&fbdo, "/atuais/bpm", bpmAvg);
  Firebase.RTDB.setInt(&fbdo, "/atuais/spo2", spo2);

  Serial.println("Firebase atualizado");
}

// =============================================================

void displayMessage(const char* l1, const char* l2, const char* l3) {
  u8g2.clearBuffer();
  u8g2.drawStr(10, 20, l1);
  u8g2.drawStr(10, 35, l2);
  u8g2.drawStr(10, 50, l3);
  u8g2.sendBuffer();
}
