<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MonitorMed • Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #38bdf8;
            --primary-dark: #0ea5e9;
            --bg-dark: #020617;
            --bg-card: rgba(2, 6, 23, 0.85);
            --bg-hover: rgba(15, 23, 42, 0.8);
            --text-light: #e5e7eb;
            --text-muted: #94a3b8;
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #10b981;
            --border-color: rgba(56, 189, 248, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--bg-dark), #0f172a);
            color: var(--text-light);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 30px;
            background: rgba(2, 6, 23, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--primary);
            font-size: 1.5rem;
        }

        .logout-btn {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.5);
            color: var(--danger);
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.3);
            transform: translateY(-2px);
        }

        /* Main Content */
        .dashboard {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 25px;
            padding: 25px;
        }

        @media (max-width: 1200px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
            animation: fadeUp 0.6s ease;
            margin-bottom: 20px;
        }

        @keyframes fadeUp {
            from {
                opacity: 0;
                transform: translateY(40px);
            }
            to {
                opacity: 1;
                transform: none;
            }
        }

        .card-title {
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Patient Info */
        .patient-info {
            margin-bottom: 25px;
        }

        .patient-name {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 5px;
        }

        .patient-id {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        /* Sensors */
        .sensor-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 18px 0;
            padding: 18px;
            border-radius: 14px;
            background: var(--bg-hover);
            transition: all 0.3s ease;
            position: relative;
        }

        .sensor-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        .sensor-label {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.1rem;
        }

        .sensor-value {
            font-size: 1.6rem;
            font-weight: 700;
        }

        /* Status Indicators */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .status-indicator.normal {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
        }

        .status-indicator.warning {
            background: rgba(245, 158, 11, 0.15);
            color: #f59e0b;
        }

        .status-indicator.critical {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }

        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        @media (max-width: 1400px) {
            .charts-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 900px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        .chart-card {
            margin-bottom: 0;
        }

        .chart-container {
            height: 250px;
            position: relative;
        }

        /* Chart Labels */
        .chart-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 0 10px;
        }

        .chart-ranges {
            display: flex;
            flex-direction: column;
            gap: 5px;
            font-size: 0.85rem;
        }

        .range-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .range-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .range-normal { background: #10b981; }
        .range-warning { background: #f59e0b; }
        .range-critical { background: #ef4444; }

        /* Toggle Buttons */
        .view-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .toggle-btn {
            flex: 1;
            padding: 12px 20px;
            background: var(--bg-hover);
            border: 1px solid var(--border-color);
            color: var(--text-light);
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .toggle-btn:hover {
            background: rgba(56, 189, 248, 0.1);
        }

        .toggle-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th,
        .data-table td {
            padding: 14px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table th {
            background: rgba(56, 189, 248, 0.1);
            color: var(--primary);
            font-weight: 600;
        }

        .data-table tbody tr:hover {
            background: rgba(56, 189, 248, 0.05);
        }

        /* Hidden State */
        .hidden {
            display: none !important;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 20px;
            color: var(--text-muted);
            font-size: 0.9rem;
            border-top: 1px solid var(--border-color);
            margin-top: 30px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-title">
            <i class="fas fa-heart-pulse"></i>
            <h2>Monitoramento</h2>
        </div>
        <button class="logout-btn" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i>
            Sair
        </button>
    </header>

    <!-- Main Dashboard -->
    <main class="dashboard">
        <!-- Left Column: Patient Info -->
        <div class="left-column">
            <div class="card">
                <h3 class="card-title">
                    <i class="fas fa-user-injured"></i>
                    Paciente
                </h3>
                <div class="patient-info">
                    <div class="patient-name" id="patientName">---</div>
                    <div class="patient-id" id="patientId">ID: ---</div>
                </div>
                
                <div class="sensor-item" id="heartRateCard">
                    <div class="sensor-label">
                        <i class="fas fa-heart"></i>
                        <span>Frequência Cardíaca</span>
                    </div>
                    <div class="sensor-value" id="heartRate">--</div>
                    <div class="status-indicator" id="heartRateStatus">--</div>
                </div>
                
                <div class="sensor-item" id="oxygenCard">
                    <div class="sensor-label">
                        <i class="fas fa-tint"></i>
                        <span>Oxigenação</span>
                    </div>
                    <div class="sensor-value" id="oxygenLevel">--</div>
                    <div class="status-indicator" id="oxygenStatus">--</div>
                </div>
                
                <div class="sensor-item" id="tempCard">
                    <div class="sensor-label">
                        <i class="fas fa-thermometer-half"></i>
                        <span>Temperatura</span>
                    </div>
                    <div class="sensor-value" id="temperature">--</div>
                    <div class="status-indicator" id="tempStatus">--</div>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">
                    <i class="fas fa-user-md"></i>
                    Responsável
                </h3>
                <div id="userInfo" class="patient-info">
                    Carregando informações do usuário...
                </div>
            </div>
        </div>

        <!-- Right Column: History -->
        <div class="right-column">
            <div class="card">
                <div class="view-toggle">
                    <button class="toggle-btn active" id="btnChart">
                        <i class="fas fa-chart-line"></i>
                        Gráficos
                    </button>
                    <button class="toggle-btn" id="btnTable">
                        <i class="fas fa-table"></i>
                        Tabela
                    </button>
                </div>

                <!-- Chart View -->
                <div id="chartView">
                    <h3 class="card-title">
                        <i class="fas fa-history"></i>
                        Histórico - Últimas 24 horas
                    </h3>
                    
                    <div class="charts-grid">
                        <!-- Heart Rate Chart -->
                        <div class="card chart-card">
                            <div class="chart-info">
                                <div class="sensor-label">
                                    <i class="fas fa-heart" style="color: #ef4444;"></i>
                                    <span style="font-weight: 600;">Frequência Cardíaca</span>
                                </div>
                                <div class="chart-ranges">
                                    <div class="range-item">
                                        <span class="range-dot range-normal"></span>
                                        <span>Normal: 60–100</span>
                                    </div>
                                    <div class="range-item">
                                        <span class="range-dot range-warning"></span>
                                        <span>Atenção: 50–59 ou 101–110</span>
                                    </div>
                                    <div class="range-item">
                                        <span class="range-dot range-critical"></span>
                                        <span>Crítico: <50 ou >110</span>
                                    </div>
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="heartRateChart"></canvas>
                            </div>
                        </div>

                        <!-- Oxygen Chart -->
                        <div class="card chart-card">
                            <div class="chart-info">
                                <div class="sensor-label">
                                    <i class="fas fa-tint" style="color: #3b82f6;"></i>
                                    <span style="font-weight: 600;">Oxigenação</span>
                                </div>
                                <div class="chart-ranges">
                                    <div class="range-item">
                                        <span class="range-dot range-normal"></span>
                                        <span>Normal: 95–100%</span>
                                    </div>
                                    <div class="range-item">
                                        <span class="range-dot range-warning"></span>
                                        <span>Atenção: 90–94%</span>
                                    </div>
                                    <div class="range-item">
                                        <span class="range-dot range-critical"></span>
                                        <span>Crítico: <90%</span>
                                    </div>
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="oxygenChart"></canvas>
                            </div>
                        </div>

                        <!-- Temperature Chart -->
                        <div class="card chart-card">
                            <div class="chart-info">
                                <div class="sensor-label">
                                    <i class="fas fa-thermometer-half" style="color: #f59e0b;"></i>
                                    <span style="font-weight: 600;">Temperatura</span>
                                </div>
                                <div class="chart-ranges">
                                    <div class="range-item">
                                        <span class="range-dot range-normal"></span>
                                        <span>Normal: 36.0–37.5°C</span>
                                    </div>
                                    <div class="range-item">
                                        <span class="range-dot range-warning"></span>
                                        <span>Atenção: 37.6–38.5°C</span>
                                    </div>
                                    <div class="range-item">
                                        <span class="range-dot range-critical"></span>
                                        <span>Crítico: ≥38.6°C</span>
                                    </div>
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="temperatureChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Table View -->
                <div id="tableView" class="hidden">
                    <h3 class="card-title">
                        <i class="fas fa-list-alt"></i>
                        Histórico Completo
                    </h3>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Data/Hora</th>
                                    <th>FC (bpm)</th>
                                    <th>Oxi (%)</th>
                                    <th>Temp (°C)</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                                <tr>
                                    <td colspan="5" class="loading">
                                        <i class="fas fa-spinner fa-spin"></i>
                                        Carregando dados...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <p>© 2024 MonitorMed • Sistema de Monitoramento em Tempo Real</p>
        <p>Última atualização: <span id="lastUpdate">--:--:--</span></p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDURF1Z7S-O0y1mfc0Sf8sjY9KGLJwkYHY",
            authDomain: "projeto-integradora-ii.firebaseapp.com",
            databaseURL: "https://projeto-integradora-ii-default-rtdb.firebaseio.com",
            projectId: "projeto-integradora-ii",
            storageBucket: "projeto-integradora-ii.firebasestorage.app",
            messagingSenderId: "80939508930",
            appId: "1:80939508930:web:9a2d2f9bf97be9eb98075b"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // DOM Elements
        const elements = {
            patientName: document.getElementById('patientName'),
            patientId: document.getElementById('patientId'),
            heartRate: document.getElementById('heartRate'),
            oxygenLevel: document.getElementById('oxygenLevel'),
            temperature: document.getElementById('temperature'),
            heartRateStatus: document.getElementById('heartRateStatus'),
            oxygenStatus: document.getElementById('oxygenStatus'),
            tempStatus: document.getElementById('tempStatus'),
            userInfo: document.getElementById('userInfo'),
            historyTableBody: document.getElementById('historyTableBody'),
            lastUpdate: document.getElementById('lastUpdate'),
            btnChart: document.getElementById('btnChart'),
            btnTable: document.getElementById('btnTable'),
            chartView: document.getElementById('chartView'),
            tableView: document.getElementById('tableView')
        };

        // Chart Variables
        let heartRateChart = null;
        let oxygenChart = null;
        let temperatureChart = null;
        
        let chartData = {
            labels: [],
            heartRate: [],
            oxygenLevel: [],
            temperature: []
        };

        // Health Ranges Configuration
        const ranges = {
            heartRate: {
                normal: { min: 60, max: 100 },
                warning: { min: 50, max: 110 },
                critical: { min: 0, max: 200 }
            },
            oxygen: {
                normal: { min: 95, max: 100 },
                warning: { min: 90, max: 94.9 },
                critical: { min: 0, max: 89.9 }
            },
            temperature: {
                normal: { min: 36.0, max: 37.5 },
                warning: { min: 37.6, max: 38.5 },
                critical: { min: 38.6, max: 42 }
            }
        };

        // Toggle View Functions
        elements.btnChart.addEventListener('click', () => {
            elements.btnChart.classList.add('active');
            elements.btnTable.classList.remove('active');
            elements.chartView.classList.remove('hidden');
            elements.tableView.classList.add('hidden');
            updateChartsSize();
        });

        elements.btnTable.addEventListener('click', () => {
            elements.btnTable.classList.add('active');
            elements.btnChart.classList.remove('active');
            elements.tableView.classList.remove('hidden');
            elements.chartView.classList.add('hidden');
        });

        function updateChartsSize() {
            [heartRateChart, oxygenChart, temperatureChart].forEach(chart => {
                if (chart) {
                    setTimeout(() => {
                        chart.resize();
                    }, 100);
                }
            });
        }

        // Load User Info
        function loadUserInfo() {
            const userData = sessionStorage.getItem('usuarioLogado');
            if (userData) {
                const user = JSON.parse(userData);
                elements.userInfo.innerHTML = `
                    <div class="patient-name">${user.nome}</div>
                    <div class="patient-id">Perfil: ${user.perfil}</div>
                `;
            }
        }

        // Initialize Charts
        function initCharts() {
            // Heart Rate Chart
            const heartRateCtx = document.getElementById('heartRateChart').getContext('2d');
            heartRateChart = new Chart(heartRateCtx, {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [
                        {
                            label: 'Frequência Cardíaca (bpm)',
                            data: chartData.heartRate,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true,
                            pointBackgroundColor: '#ef4444',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }
                    ]
                },
                options: getChartOptions('Frequência Cardíaca (bpm)', 'bpm', ranges.heartRate)
            });

            // Oxygen Chart
            const oxygenCtx = document.getElementById('oxygenChart').getContext('2d');
            oxygenChart = new Chart(oxygenCtx, {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [
                        {
                            label: 'Oxigenação (%)',
                            data: chartData.oxygenLevel,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true,
                            pointBackgroundColor: '#3b82f6',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }
                    ]
                },
                options: getChartOptions('Oxigenação (%)', '%', ranges.oxygen)
            });

            // Temperature Chart
            const tempCtx = document.getElementById('temperatureChart').getContext('2d');
            temperatureChart = new Chart(tempCtx, {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [
                        {
                            label: 'Temperatura (°C)',
                            data: chartData.temperature,
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true,
                            pointBackgroundColor: '#f59e0b',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }
                    ]
                },
                options: getChartOptions('Temperatura (°C)', '°C', ranges.temperature)
            });
        }

        function getChartOptions(title, unit, rangesConfig) {
            return {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                return `${context.dataset.label}: ${context.parsed.y}${unit}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: '#94a3b8',
                            maxTicksLimit: 8
                        }
                    },
                    y: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: '#94a3b8'
                        },
                        min: function(context) {
                            const min = Math.min(...context.chart.data.datasets[0].data);
                            return Math.floor(min * 0.95);
                        },
                        max: function(context) {
                            const max = Math.max(...context.chart.data.datasets[0].data);
                            return Math.ceil(max * 1.05);
                        }
                    }
                },
                annotation: {
                    annotations: {
                        normalRange: {
                            type: 'box',
                            yMin: rangesConfig.normal.min,
                            yMax: rangesConfig.normal.max,
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderColor: 'rgba(16, 185, 129, 0.3)',
                            borderWidth: 1
                        },
                        warningRange: [
                            {
                                type: 'box',
                                yMin: rangesConfig.warning.min,
                                yMax: rangesConfig.warning.max,
                                backgroundColor: 'rgba(245, 158, 11, 0.05)',
                                borderColor: 'rgba(245, 158, 11, 0.2)',
                                borderWidth: 1
                            }
                        ]
                    }
                }
            };
        }

        // Update Sensor Status
        function updateSensorStatus(value, type) {
            let status = 'normal';
            let text = 'Normal';
            
            switch(type) {
                case 'heartRate':
                    if (value < 50 || value > 110) {
                        status = 'critical';
                        text = 'Crítico';
                    } else if (value < 60 || value > 100) {
                        status = 'warning';
                        text = 'Atenção';
                    }
                    break;
                    
                case 'oxygen':
                    if (value < 90) {
                        status = 'critical';
                        text = 'Crítico';
                    } else if (value < 95) {
                        status = 'warning';
                        text = 'Atenção';
                    }
                    break;
                    
                case 'temperature':
                    if (value >= 38.6) {
                        status = 'critical';
                        text = 'Crítico';
                    } else if (value > 37.5 || value < 36.0) {
                        status = 'warning';
                        text = 'Atenção';
                    }
                    break;
            }
            
            return { status, text };
        }

        // Update Charts Data
        function updateChartsWithData(records) {
            const sortedRecords = records.sort((a, b) => 
                new Date(a.timestamp.replace('_', ' ')) - new Date(b.timestamp.replace('_', ' '))
            );

            // Get last 30 records for charts
            const recentRecords = sortedRecords.slice(-30);
            chartData.labels = recentRecords.map(r => {
                const [date, time] = r.timestamp.split('_');
                return time || r.timestamp.substring(11, 16);
            });
            chartData.heartRate = recentRecords.map(r => r.freq_cardiaca);
            chartData.oxygenLevel = recentRecords.map(r => r.oximetria);
            chartData.temperature = recentRecords.map(r => r.temperatura);

            if (heartRateChart) {
                heartRateChart.data.labels = chartData.labels;
                heartRateChart.data.datasets[0].data = chartData.heartRate;
                heartRateChart.update('none');
                
                oxygenChart.data.labels = chartData.labels;
                oxygenChart.data.datasets[0].data = chartData.oxygenLevel;
                oxygenChart.update('none');
                
                temperatureChart.data.labels = chartData.labels;
                temperatureChart.data.datasets[0].data = chartData.temperature;
                temperatureChart.update('none');
            } else {
                initCharts();
            }
        }

        // Update Table
        function updateTable(records) {
            let html = '';
            if (!records || records.length === 0) {
                html = `
                <tr>
                    <td colspan="5" style="text-align: center; color: var(--text-muted); padding: 40px;">
                        <i class="fas fa-database"></i> Nenhum registro encontrado
                    </td>
                </tr>`;
            } else {
                records.forEach(record => {
                    const [date, time] = record.timestamp.split('_');
                    const hrStatus = updateSensorStatus(record.freq_cardiaca, 'heartRate');
                    const oxStatus = updateSensorStatus(record.oximetria, 'oxygen');
                    const tempStatus = updateSensorStatus(record.temperatura, 'temperature');
                    
                    // Get overall status (worst status)
                    const statuses = [hrStatus.status, oxStatus.status, tempStatus.status];
                    let overallStatus = 'normal';
                    if (statuses.includes('critical')) overallStatus = 'critical';
                    else if (statuses.includes('warning')) overallStatus = 'warning';
                    
                    html += `
                    <tr>
                        <td>${date} ${time || ''}</td>
                        <td>
                            <span class="sensor-value" style="color: ${hrStatus.status === 'critical' ? '#ef4444' : hrStatus.status === 'warning' ? '#f59e0b' : '#10b981'}">
                                ${record.freq_cardiatica}
                            </span>
                        </td>
                        <td>
                            <span class="sensor-value" style="color: ${oxStatus.status === 'critical' ? '#ef4444' : oxStatus.status === 'warning' ? '#f59e0b' : '#10b981'}">
                                ${record.oximetria}
                            </span>
                        </td>
                        <td>
                            <span class="sensor-value" style="color: ${tempStatus.status === 'critical' ? '#ef4444' : tempStatus.status === 'warning' ? '#f59e0b' : '#10b981'}">
                                ${record.temperatura}
                            </span>
                        </td>
                        <td>
                            <span class="status-indicator ${overallStatus}">
                                <i class="fas fa-circle"></i>
                                ${overallStatus === 'critical' ? 'Crítico' : overallStatus === 'warning' ? 'Atenção' : 'Normal'}
                            </span>
                        </td>
                    </tr>`;
                });
            }
            elements.historyTableBody.innerHTML = html;
        }

        // Update Last Update Time
        function updateLastUpdateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('pt-BR');
            elements.lastUpdate.textContent = timeString;
        }

        // Firebase Listeners
        onValue(ref(db, 'Paciente'), snap => {
            const patient = snap.val();
            if (patient) {
                elements.patientName.textContent = patient.nome || '---';
                elements.patientId.textContent = `ID: ${patient.id_paciente || '---'}`;
            }
        });

        onValue(ref(db, 'Sensores-atuais'), snap => {
            const sensors = snap.val();
            if (sensors) {
                // Update values
                elements.heartRate.textContent = `${sensors.freq_cardiaca || '--'} bpm`;
                elements.oxygenLevel.textContent = `${sensors.oximetria || '--'} %`;
                elements.temperature.textContent = `${sensors.temperatura || '--'} °C`;
                
                // Update status indicators
                const hrStatus = updateSensorStatus(sensors.freq_cardiaca, 'heartRate');
                const oxStatus = updateSensorStatus(sensors.oximetria, 'oxygen');
                const tempStatus = updateSensorStatus(sensors.temperatura, 'temperature');
                
                elements.heartRateStatus.textContent = hrStatus.text;
                elements.heartRateStatus.className = `status-indicator ${hrStatus.status}`;
                elements.heartRateStatus.previousElementSibling.style.color = 
                    hrStatus.status === 'critical' ? '#ef4444' : 
                    hrStatus.status === 'warning' ? '#f59e0b' : '#10b981';
                
                elements.oxygenStatus.textContent = oxStatus.text;
                elements.oxygenStatus.className = `status-indicator ${oxStatus.status}`;
                elements.oxygenStatus.previousElementSibling.style.color = 
                    oxStatus.status === 'critical' ? '#ef4444' : 
                    oxStatus.status === 'warning' ? '#f59e0b' : '#10b981';
                
                elements.tempStatus.textContent = tempStatus.text;
                elements.tempStatus.className = `status-indicator ${tempStatus.status}`;
                elements.tempStatus.previousElementSibling.style.color = 
                    tempStatus.status === 'critical' ? '#ef4444' : 
                    tempStatus.status === 'warning' ? '#f59e0b' : '#10b981';
                
                updateLastUpdateTime();
            }
        });

        onValue(ref(db, 'Sensores-historico'), snap => {
            const data = snap.val();
            if (data) {
                const records = Object.keys(data).map(key => ({
                    ...data[key],
                    key: key
                }));
                
                // Update charts
                updateChartsWithData(records);
                
                // Update table (show last 50 records)
                const tableRecords = records.slice(-50).reverse();
                updateTable(tableRecords);
            } else {
                updateTable([]);
            }
        });

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            loadUserInfo();
            updateLastUpdateTime();
            setInterval(updateLastUpdateTime, 1000);
        });

        // Logout function
        window.logout = function() {
            sessionStorage.clear();
            window.location.href = 'index.html';
        };

        // Handle window resize for charts
        window.addEventListener('resize', updateChartsSize);
    </script>
</body>
</html> 
