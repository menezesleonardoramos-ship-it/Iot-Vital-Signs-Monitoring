#include <WiFi.h>
#include <Firebase_ESP_Client.h>
#include "time.h"

// ================= WIFI =================
#define WIFI_SSID "Emerson"
#define WIFI_PASSWORD "guebas123"

// ================= FIREBASE =================
#define DATABASE_URL "projeto-integradora-ii-default-rtdb.firebaseio.com"
#define DATABASE_SECRET "uC0SyV22Gi3CEPqkslCwpJtPB1Kr2EAiH9JmrMVD"  // Database Secret do Firebase

// Firebase objects
FirebaseData fbdo;
FirebaseAuth auth;
FirebaseConfig config;

// Flag para controle de sincronização de tempo
bool timeSynced = false;
unsigned long dataMillis = 0;

void setup() {
  Serial.begin(115200);
  delay(1000);

  Serial.println("Iniciando dispositivo ESP32-C3...");

  // Conecta no WiFi
  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
  Serial.print("Conectando ao WiFi");

  int wifiTimeout = 0;
  while (WiFi.status() != WL_CONNECTED && wifiTimeout < 30) {
    delay(500);
    Serial.print(".");
    wifiTimeout++;
  }

  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("\nFalha ao conectar WiFi! Reiniciando...");
    delay(2000);
    ESP.restart();
  }

  Serial.println("\nWiFi conectado!");
  Serial.print("IP address: ");
  Serial.println(WiFi.localIP());

  // Configuração do Firebase
  config.database_url = DATABASE_URL;
  config.signer.tokens.legacy_token = DATABASE_SECRET;

  // Opcional: configurar timeout
  config.timeout.serverResponse = 10 * 1000;  // 10 segundos
  config.timeout.sslHandshake = 30 * 1000;    // 30 segundos

  // Inicializa Firebase
  Firebase.begin(&config, &auth);
  Firebase.reconnectWiFi(true);

  Serial.print("Conectando ao Firebase...");
  
  // Aguarda conexão com Firebase
  int fbTimeout = 0;
  while (!Firebase.ready() && fbTimeout < 20) {
    Serial.print(".");
    delay(500);
    fbTimeout++;
  }

  if (Firebase.ready()) {
    Serial.println("\nFirebase conectado com sucesso!");
  } else {
    Serial.println("\nFalha ao conectar Firebase!");
    Serial.println("Verifique suas credenciais e conexão WiFi.");
  }

  // Configuração do NTP para horário
  configTime(-3 * 3600, 0, "pool.ntp.org", "time.nist.gov");
  
  // Aguarda sincronização do horário (não bloqueante)
  Serial.print("Sincronizando horário");
  unsigned long ntpStart = millis();
  while (time(nullptr) < 24 * 3600) {
    if (millis() - ntpStart > 30000) {  // Timeout de 30 segundos
      Serial.println("\nTimeout na sincronização NTP!");
      break;
    }
    Serial.print(".");
    delay(1000);
  }
  
  time_t now = time(nullptr);
  if (now > 24 * 3600) {
    timeSynced = true;
    Serial.println("\nHorário sincronizado!");
  } else {
    Serial.println("\nUsando horário padrão.");
  }
}

void loop() {
  // Aguarda sincronização de tempo
  if (!timeSynced) {
    time_t now = time(nullptr);
    if (now > 24 * 3600) {
      timeSynced = true;
      Serial.println("Horário sincronizado!");
    } else {
      delay(1000);
      return;
    }
  }

  // Envia dados a cada 5 segundos
  if (millis() - dataMillis > 5000 || dataMillis == 0) {
    dataMillis = millis();

    // Obtém horário atual
    time_t now = time(nullptr);
    struct tm* timeinfo = localtime(&now);

    // Formata data e hora para string
    char dataHora[30];
    sprintf(dataHora, "%04d-%02d-%02d_%02d-%02d-%02d",
            timeinfo->tm_year + 1900,
            timeinfo->tm_mon + 1,
            timeinfo->tm_mday,
            timeinfo->tm_hour,
            timeinfo->tm_min,
            timeinfo->tm_sec);

    // Gera valores aleatórios
    randomSeed(micros() + analogRead(0));  // Seed mais aleatória
    int temperatura = random(20, 36);      // 20 a 35 °C
    int oximetria = random(40, 80);        // 40% a 79%
    int freq_cardiaca = random(60, 120);   // 60 a 119 BPM (mais realista)

    Serial.println("\n=================================");
    Serial.print("Data/Hora: ");
    Serial.println(dataHora);
    Serial.print("Temperatura: ");
    Serial.print(temperatura);
    Serial.println(" °C");
    Serial.print("Oximetria: ");
    Serial.print(oximetria);
    Serial.println(" %");
    Serial.print("Freq. Cardíaca: ");
    Serial.print(freq_cardiaca);
    Serial.println(" BPM");
    Serial.println("=================================");

    // Verifica se Firebase está pronto
    if (!Firebase.ready()) {
      Serial.println("Firebase não está pronto! Tentando reconectar...");
      Firebase.reconnectWiFi(true);
      delay(1000);
      return;
    }

    // Envia valores atuais para o Firebase
    if (Firebase.RTDB.setInt(&fbdo, "/sensores_atuais/temperatura", temperatura)) {
      Serial.println("✓ Temperatura enviada");
    } else {
      Serial.print("✗ Erro temperatura: ");
      Serial.println(fbdo.errorReason().c_str());
    }

    if (Firebase.RTDB.setInt(&fbdo, "/sensores_atuais/oximetria", oximetria)) {
      Serial.println("✓ Oximetria enviada");
    } else {
      Serial.print("✗ Erro oximetria: ");
      Serial.println(fbdo.errorReason().c_str());
    }

    if (Firebase.RTDB.setInt(&fbdo, "/sensores_atuais/freq_cardiaca", freq_cardiaca)) {
      Serial.println("✓ Frequência cardíaca enviada");
    } else {
      Serial.print("✗ Erro freq cardíaca: ");
      Serial.println(fbdo.errorReason().c_str());
    }

    // Envia para histórico com timestamp como chave
    String pathHistorico = "/sensores_historico/" + String(dataHora);
    
    // Cria um objeto JSON para o histórico
    FirebaseJson json;
    json.set("temperatura", temperatura);
    json.set("oximetria", oximetria);
    json.set("freq_cardiaca", freq_cardiaca);
    json.set("timestamp", dataHora);

    // Envia o JSON completo para o histórico
    if (Firebase.RTDB.setJSON(&fbdo, pathHistorico.c_str(), &json)) {
      Serial.println("✓ Histórico salvo com sucesso!");
    } else {
      Serial.print("✗ Erro histórico: ");
      Serial.println(fbdo.errorReason().c_str());
    }

    // Alternativa: enviar dados separados (mantendo sua estrutura original)
    /*
    String pathTemp = "/sensores_historico/temperatura/" + String(dataHora);
    String pathOxi = "/sensores_historico/oximetria/" + String(dataHora);
    String pathFreq = "/sensores_historico/freq_cardiaca/" + String(dataHora);
    
    Firebase.RTDB.setInt(&fbdo, pathTemp.c_str(), temperatura);
    Firebase.RTDB.setInt(&fbdo, pathOxi.c_str(), oximetria);
    Firebase.RTDB.setInt(&fbdo, pathFreq.c_str(), freq_cardiaca);
    */
  }

  delay(100);  // Pequeno delay para evitar sobrecarga
}